# Console & Web æ”¹è¿›æ€»ç»“

## æ—¥æœŸï¼š2025-10-09

## æ¦‚è¿°
æœ¬æ¬¡æ›´æ–°å¯¹ iTrade é¡¹ç›®çš„ Console åº”ç”¨å’Œ Web API è¿›è¡Œäº†å…¨é¢çš„æ”¹è¿›å’Œä¼˜åŒ–ï¼Œæå‡äº†ç³»ç»Ÿçš„å¯é æ€§ã€ç›‘æ§èƒ½åŠ›å’Œç”¨æˆ·ä½“éªŒã€‚

---

## ğŸ“Š Web ç®¡ç†å™¨ (apps/web) æ”¹è¿›

### 1. API è·¯ç”±ä¿®å¤å’Œä¼˜åŒ–

#### âœ… `/api/orders/route.ts` ä¿®å¤
**é—®é¢˜ï¼š**
- ä½¿ç”¨ä¸ä¸€è‡´çš„ `getDb()` è€Œéæ ‡å‡†çš„ `getDataManager()`
- è®¤è¯æ–¹å¼ä¸ä¸€è‡´ï¼ˆ`auth()` vs `auth.api.getSession()`ï¼‰
- ç¼ºå°‘è¾“å…¥éªŒè¯å’Œé”™è¯¯å¤„ç†

**ä¿®å¤ï¼š**
- ç»Ÿä¸€ä½¿ç”¨ `getDataManager()` è·å–æ•°æ®ç®¡ç†å™¨
- ç»Ÿä¸€ä½¿ç”¨ `auth.api.getSession()` è¿›è¡Œè®¤è¯
- æ·»åŠ  `strategyId` å‚æ•°éªŒè¯ï¼ˆæ£€æŸ¥ NaNï¼‰
- æ”¹è¿›é”™è¯¯å“åº”æ ¼å¼
- ç»Ÿä¸€è¿”å›æ ¼å¼ä¸º `{ orders }`

```typescript
// ä¿®å¤å‰
const db = await getDb();
const session = await auth();

// ä¿®å¤å
const dataManager = await getDataManager();
const session = await auth.api.getSession({ headers: request.headers });
```

### 2. API ä¸€è‡´æ€§æ”¹è¿›

æ‰€æœ‰ API è·¯ç”±ç°åœ¨éµå¾ªç»Ÿä¸€çš„æ¨¡å¼ï¼š
- âœ… ä½¿ç”¨ `NextRequest` ç±»å‹
- âœ… ç»Ÿä¸€çš„è®¤è¯æ–¹å¼
- âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
- âœ… ä¸€è‡´çš„å“åº”æ ¼å¼
- âœ… å®Œæ•´çš„è¾“å…¥éªŒè¯

### 3. ç±»å‹å®‰å…¨

- æ‰€æœ‰ API è·¯ç”±éƒ½æœ‰æ­£ç¡®çš„ TypeScript ç±»å‹
- ä½¿ç”¨ `RouteContext` ç±»å‹å¤„ç†åŠ¨æ€è·¯ç”±å‚æ•°
- æ­£ç¡®å¤„ç†å¯é€‰å‚æ•°å’Œç±»å‹è½¬æ¢

---

## ğŸš€ Console åº”ç”¨ (apps/console) é‡å¤§æ”¹è¿›

### 1. ç­–ç•¥ç®¡ç†å™¨ (StrategyManager) å¢å¼º

#### æ–°å¢æ€§èƒ½ç›‘æ§åŠŸèƒ½

**æ·»åŠ çš„æŒ‡æ ‡è¿½è¸ªï¼š**
```typescript
interface StrategyMetrics {
  startTime: Date;              // ç­–ç•¥å¼€å§‹æ—¶é—´
  totalSignals: number;         // ç”Ÿæˆçš„ä¿¡å·æ€»æ•°
  totalOrders: number;          // æ‰§è¡Œçš„è®¢å•æ€»æ•°
  lastSignalTime?: Date;        // æœ€åä¿¡å·æ—¶é—´
  lastOrderTime?: Date;         // æœ€åè®¢å•æ—¶é—´
  errors: number;               // é”™è¯¯è®¡æ•°
}
```

#### å®æ—¶äº‹ä»¶ç›‘å¬

- è‡ªåŠ¨è¿½è¸ªç­–ç•¥ä¿¡å·ç”Ÿæˆ
- è‡ªåŠ¨è¿½è¸ªè®¢å•åˆ›å»º
- ä» `clientOrderId` ä¸­æå–ç­–ç•¥ IDï¼ˆæ ¼å¼ï¼š`strategy_{id}_{timestamp}`ï¼‰
- å®æ—¶æ›´æ–°æ€§èƒ½æŒ‡æ ‡

#### å®šæœŸæ€§èƒ½æŠ¥å‘Š

æ¯60ç§’ç”Ÿæˆè¯¦ç»†çš„æ€§èƒ½æŠ¥å‘Šï¼š

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š Strategy Performance Report
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ˆ strategy_1:
   Running for: 2.50h (150m)
   Signals generated: 45
   Orders executed: 12
   Last signal: 30s ago
   Last order: 120s ago
   ğŸ’° Total PnL: 125.50
   ğŸ’µ Realized PnL: 100.00
   ğŸ“Š Total Orders: 12 (10 filled)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

#### æ”¹è¿›çš„ç­–ç•¥ç”Ÿå‘½å‘¨æœŸç®¡ç†

- âœ… æ·»åŠ ç­–ç•¥æ—¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼ˆç±»å‹ã€äº¤æ˜“å¯¹ã€äº¤æ˜“æ‰€ï¼‰
- âœ… ç§»é™¤ç­–ç•¥æ—¶æ˜¾ç¤ºæœ€ç»ˆæŒ‡æ ‡
- âœ… æ›´å¥½çš„æ—¥å¿—æ ¼å¼ï¼ˆä½¿ç”¨è¡¨æƒ…ç¬¦å·å’Œåˆ†éš”çº¿ï¼‰

### 2. ä¸»ç¨‹åº (main.ts) å¢å¼º

#### å…¨é¢çš„è®¢å•ç”Ÿå‘½å‘¨æœŸè¿½è¸ª

ç°åœ¨è¿½è¸ªæ‰€æœ‰è®¢å•äº‹ä»¶ï¼š

```typescript
// è®¢å•åˆ›å»º
eventBus.onOrderCreated((data) => {
  logger.info(`ğŸ“ ORDER CREATED: ${side} ${quantity} ${symbol} @ ${price}`);
});

// è®¢å•æˆäº¤
eventBus.onOrderFilled((data) => {
  logger.info(`âœ… ORDER FILLED: ${orderId}`);
});

// éƒ¨åˆ†æˆäº¤
eventBus.onOrderPartiallyFilled((data) => {
  logger.info(`â³ ORDER PARTIAL FILL: ${filled}/${total}`);
});

// è®¢å•å–æ¶ˆ
eventBus.onOrderCancelled((data) => {
  logger.info(`âŒ ORDER CANCELLED: ${orderId}`);
});

// è®¢å•æ‹’ç»
eventBus.onOrderRejected((data) => {
  logger.error(`ğŸš« ORDER REJECTED: ${orderId}`);
});
```

#### æ”¹è¿›çš„å¯åŠ¨æ—¥å¿—

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸš€ iTrade Trading System is LIVE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š Active strategies are loaded from database
ğŸ”„ Monitoring for strategy updates every second
ğŸ“ˆ Performance reports every 60 seconds
ğŸ’¼ Orders will be tracked and saved to database
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

#### ä¼˜é›…çš„å…³é—­å¤„ç†

- âœ… æ•è· SIGINT å’Œ SIGTERM ä¿¡å·
- âœ… æŒ‰é¡ºåºå…³é—­æ‰€æœ‰ç»„ä»¶
- âœ… ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
- âœ… å¤„ç† uncaughtException å’Œ unhandledRejection
- âœ… è¯¦ç»†çš„å…³é—­æ—¥å¿—

### 3. è®¢å•è¿½è¸ªå™¨ (OrderTracker) å¢å¼º

#### ç»Ÿè®¡è¿½è¸ª

```typescript
private totalOrders = 0;      // åˆ›å»ºçš„è®¢å•æ€»æ•°
private totalFilled = 0;       // æˆäº¤çš„è®¢å•æ•°
private totalCancelled = 0;    // å–æ¶ˆçš„è®¢å•æ•°
private totalRejected = 0;     // æ‹’ç»çš„è®¢å•æ•°
```

#### æ”¹è¿›çš„æ•°æ®åº“ä¿å­˜

- âœ… è‡ªåŠ¨ä» `clientOrderId` æå–ç­–ç•¥ ID
- âœ… æ­£ç¡®å…³è”è®¢å•ä¸ç­–ç•¥
- âœ… è®¡ç®—å¹¶ä¿å­˜ PnLï¼ˆå·²å®ç°ç›ˆäºå’Œæœªå®ç°ç›ˆäºï¼‰
- âœ… ä¿å­˜å¹³å‡æˆäº¤ä»·æ ¼
- âœ… æ›´è¯¦ç»†çš„æ—¥å¿—è¾“å‡º

#### æœ€ç»ˆæŠ¥å‘Š

åœæ­¢æ—¶ç”Ÿæˆå®Œæ•´æŠ¥å‘Šï¼š

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š Order Tracker Final Report
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   Total Orders Created: 50
   Orders Filled: 42
   Orders Cancelled: 5
   Orders Rejected: 3
   Running time: 2.50 hours
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

---

## ğŸ”„ å·¥ä½œæµç¨‹

### å®Œæ•´çš„ç­–ç•¥æ‰§è¡Œæµç¨‹

1. **å¯åŠ¨é˜¶æ®µ**
   ```
   Database Connection â†’ Trading Engine â†’ Exchange Connection â†’ 
   Strategy Manager â†’ Order Tracker â†’ Event Listeners
   ```

2. **è¿è¡Œé˜¶æ®µ**
   ```
   Monitor DB (1s) â†’ Load/Remove Strategies â†’ Execute Strategies â†’ 
   Generate Signals â†’ Create Orders â†’ Track Orders â†’ Save to DB â†’ 
   Generate Reports (60s)
   ```

3. **å…³é—­é˜¶æ®µ**
   ```
   Stop Strategy Manager (with final metrics) â†’ 
   Stop Order Tracker (with final report) â†’ 
   Stop Trading Engine â†’ Disconnect Exchange â†’ Close Database
   ```

### ç­–ç•¥-è®¢å•å…³è”

è®¢å•é€šè¿‡ `clientOrderId` è‡ªåŠ¨å…³è”åˆ°ç­–ç•¥ï¼š

```typescript
// ç­–ç•¥ç”Ÿæˆè®¢å•æ—¶
clientOrderId: `strategy_${strategyId}_${timestamp}`

// è®¢å•è¿½è¸ªå™¨æå–ç­–ç•¥ID
const match = clientOrderId.match(/^strategy_(\d+)_/);
const strategyId = parseInt(match[1]);

// ä¿å­˜åˆ°æ•°æ®åº“
await dataManager.saveOrder({
  ...orderData,
  strategy: { id: strategyId }
});
```

---

## ğŸ¯ å…³é”®ç‰¹æ€§

### 1. æ•°æ®åº“é©±åŠ¨
- âœ… ç­–ç•¥ä»æ•°æ®åº“åŠ è½½
- âœ… æ¯ç§’æ£€æŸ¥ç­–ç•¥æ›´æ–°
- âœ… è‡ªåŠ¨æ·»åŠ æ–°çš„æ´»åŠ¨ç­–ç•¥
- âœ… è‡ªåŠ¨ç§»é™¤åœæ­¢çš„ç­–ç•¥
- âœ… æ‰€æœ‰è®¢å•ä¿å­˜åˆ°æ•°æ®åº“

### 2. å®æ—¶ç›‘æ§
- âœ… ç­–ç•¥ä¿¡å·è¿½è¸ª
- âœ… è®¢å•ç”Ÿå‘½å‘¨æœŸè¿½è¸ª
- âœ… æ€§èƒ½æŒ‡æ ‡å®æ—¶æ›´æ–°
- âœ… é”™è¯¯å’Œå¼‚å¸¸è¿½è¸ª

### 3. è¯¦ç»†æŠ¥å‘Š
- âœ… æ¯åˆ†é’Ÿæ€§èƒ½æŠ¥å‘Š
- âœ… ç­–ç•¥è¿è¡Œæ—¶é•¿
- âœ… ä¿¡å·å’Œè®¢å•ç»Ÿè®¡
- âœ… PnL è®¡ç®—å’Œæ˜¾ç¤º
- âœ… æœ€ç»ˆç»Ÿè®¡æŠ¥å‘Š

### 4. å¥å£®æ€§
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… ä¼˜é›…å…³é—­æœºåˆ¶
- âœ… å¼‚å¸¸æ•è·å’Œæ—¥å¿—
- âœ… æ•°æ®åº“äº‹åŠ¡ç®¡ç†

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### å¯åŠ¨ Console åº”ç”¨

```bash
cd apps/console
pnpm dev
```

### æŸ¥çœ‹å®æ—¶æ—¥å¿—

ç³»ç»Ÿå°†æ˜¾ç¤ºï¼š
- ğŸ¯ ç­–ç•¥ä¿¡å·ç”Ÿæˆ
- ğŸ“ è®¢å•åˆ›å»º
- âœ… è®¢å•æˆäº¤
- ğŸ’¾ æ•°æ®åº“ä¿å­˜ç¡®è®¤
- ğŸ“Š å®šæœŸæ€§èƒ½æŠ¥å‘Š

### ç®¡ç†ç­–ç•¥ï¼ˆé€šè¿‡ Web ç•Œé¢æˆ–æ•°æ®åº“ï¼‰

1. åˆ›å»ºæ–°ç­–ç•¥ â†’ Console è‡ªåŠ¨æ£€æµ‹å¹¶åŠ è½½
2. æ›´æ–°ç­–ç•¥çŠ¶æ€ä¸º ACTIVE â†’ å¼€å§‹æ‰§è¡Œ
3. æ›´æ–°ç­–ç•¥çŠ¶æ€ä¸º STOPPED â†’ è‡ªåŠ¨åœæ­¢å¹¶ç§»é™¤
4. æ‰€æœ‰å˜æ›´åœ¨1ç§’å†…ç”Ÿæ•ˆ

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### äº‹ä»¶æ€»çº¿é›†æˆ

ä½¿ç”¨ `EventBus` å®ç°ç»„ä»¶é—´é€šä¿¡ï¼š

```typescript
// ç­–ç•¥ç®¡ç†å™¨ç›‘å¬ä¿¡å·å’Œè®¢å•
eventBus.onStrategySignal() // è¿½è¸ªä¿¡å·
eventBus.onOrderCreated()   // è¿½è¸ªè®¢å•

// è®¢å•è¿½è¸ªå™¨ç›‘å¬è®¢å•çŠ¶æ€
eventBus.onOrderCreated()
eventBus.onOrderFilled()
eventBus.onOrderPartiallyFilled()
eventBus.onOrderCancelled()
eventBus.onOrderRejected()
```

### æ€§èƒ½ä¼˜åŒ–

- âœ… é«˜æ•ˆçš„å®šæ—¶å™¨ç®¡ç†
- âœ… æ‰¹é‡æ•°æ®åº“æ“ä½œ
- âœ… å¼‚æ­¥é”™è¯¯å¤„ç†
- âœ… å†…å­˜ä¸­çš„æŒ‡æ ‡ç¼“å­˜

### ä»£ç è´¨é‡

- âœ… å®Œæ•´çš„ TypeScript ç±»å‹
- âœ… æ—  linter é”™è¯¯
- âœ… ä¸€è‡´çš„ä»£ç é£æ ¼
- âœ… è¯¦ç»†çš„æ³¨é‡Šå’Œæ—¥å¿—

---

## ğŸ“ˆ åç»­ä¼˜åŒ–å»ºè®®

1. **æ·»åŠ æ›´å¤šç­–ç•¥ç±»å‹**
   - RSI Strategy
   - MACD Strategy
   - Bollinger Bands Strategy

2. **å¢å¼º PnL è®¡ç®—**
   - è€ƒè™‘æ‰‹ç»­è´¹
   - å¤šå¸ç§æ”¯æŒ
   - å®æ—¶å¸‚åœºä»·æ ¼æ›´æ–°

3. **Web ç•Œé¢å¢å¼º**
   - å®æ—¶ç­–ç•¥çŠ¶æ€æ›´æ–°ï¼ˆWebSocketï¼‰
   - å›¾è¡¨å¯è§†åŒ–
   - å†å²æ€§èƒ½åˆ†æ

4. **å‘Šè­¦ç³»ç»Ÿ**
   - é”™è¯¯å‘Šè­¦
   - æ€§èƒ½å‘Šè­¦
   - PnL å‘Šè­¦

5. **å¤‡ä»½å’Œæ¢å¤**
   - ç­–ç•¥é…ç½®å¤‡ä»½
   - æ•°æ®åº“å®šæœŸå¤‡ä»½
   - ç¾éš¾æ¢å¤è®¡åˆ’

---

## âœ… æµ‹è¯•å»ºè®®

1. **å•å…ƒæµ‹è¯•**
   - ç­–ç•¥ç®¡ç†å™¨é€»è¾‘
   - è®¢å•è¿½è¸ªå™¨é€»è¾‘
   - PnL è®¡ç®—

2. **é›†æˆæµ‹è¯•**
   - å®Œæ•´çš„è®¢å•æµç¨‹
   - ç­–ç•¥ç”Ÿå‘½å‘¨æœŸ
   - æ•°æ®åº“æŒä¹…åŒ–

3. **æ€§èƒ½æµ‹è¯•**
   - å¤šç­–ç•¥å¹¶å‘
   - é«˜é¢‘è®¢å•å¤„ç†
   - é•¿æ—¶é—´è¿è¡Œç¨³å®šæ€§

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡æ›´æ–°å®ç°äº†ï¼š

âœ… **Console åº”ç”¨å®Œå…¨å¯ç”¨** - çœŸæ­£ä»æ•°æ®åº“åŠ è½½å’Œæ‰§è¡Œç­–ç•¥  
âœ… **å®Œæ•´çš„ç›‘æ§å’ŒæŠ¥å‘Š** - å®æ—¶æ€§èƒ½è¿½è¸ªå’Œè¯¦ç»†æ—¥å¿—  
âœ… **å¥å£®çš„é”™è¯¯å¤„ç†** - ä¼˜é›…å…³é—­å’Œå¼‚å¸¸æ•è·  
âœ… **Web API ä¼˜åŒ–** - ç»Ÿä¸€çš„æ¥å£å’Œé”™è¯¯å¤„ç†  
âœ… **é›¶ Linter é”™è¯¯** - é«˜è´¨é‡çš„ä»£ç æ ‡å‡†  

ç³»ç»Ÿç°åœ¨å·²ç»å‡†å¤‡å¥½è¿›è¡ŒçœŸå®äº¤æ˜“æµ‹è¯•ï¼ˆå»ºè®®å…ˆä½¿ç”¨æµ‹è¯•ç½‘ï¼‰ï¼

